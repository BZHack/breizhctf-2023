FROM debian:stable

ENV TIMEZONE Europe/Paris

RUN apt update -y && apt upgrade -y

# SSH (openssh-server) + Pivot SSH (chall)
RUN echo "[+] Install SSH server (+ config)"
RUN apt install -y openssh-server
RUN useradd chall --no-create-home --shell /bin/false
#RUN echo 'chall:chall' | chpasswd

# Apache & PHP
RUN echo "[+] Install Apache2 & PHP"
RUN apt install -y apache2 ca-certificates apt-transport-https lsb-release wget gnupg git
RUN apt update
RUN apt install -y php php-cli php-common php-curl php-mbstring php-mysql php-xml

# MySQL (mariadb-server)
RUN echo "[+] Install MySQL Server (+ config)"
RUN apt install -y mariadb-server mariadb-client
COPY ./sql /sql
RUN service mariadb start && \
mariadb -e "CREATE USER 'robert'@'%' IDENTIFIED BY 'assword';" && \
mariadb -e "CREATE DATABASE marche;" && \
mariadb -e "GRANT ALL ON marche.* TO 'robert'@'%'; FLUSH PRIVILEGES;" && \
mariadb marche < /sql/web.sql && \
rm -rf /sql

# Web Challenge installation
RUN echo "[+] Copy web sources (+ config)"
WORKDIR /var/www/html
RUN rm -rf *
COPY app .
RUN apt install -y unzip && \
wget https://files.phpmyadmin.net/phpMyAdmin/5.2.1/phpMyAdmin-5.2.1-all-languages.zip && \
unzip phpMyAdmin-5.2.1-all-languages.zip && \
mv phpMyAdmin-5.2.1-all-languages phpmyadmin


# Users
RUN echo "[+] Create users"
RUN useradd -ms /bin/bash administrator && \
useradd -ms /bin/bash robert && \
useradd -ms /bin/bash zeecka && \
useradd -ms /bin/bash night
COPY ./home/robert /home/robert
COPY ./home/robert/.* /home/robert/
# COPY ./home/zeecka /home/zeecka
COPY ./home/zeecka/.* ./home/zeecka/* /home/zeecka/
COPY ./home/night /home/night
COPY ./home/night/.* /home/night/
RUN chown -R robert:robert /home/robert && \
chown -R zeecka:zeecka /home/zeecka && \
chown -R night:night /home/night
RUN echo 'robert:Robert35' | chpasswd

# Gophernicus
# https://github.com/gophernicus/gophernicus/issues/99#issuecomment-880404770
WORKDIR /tmp
RUN apt install -y xinetd git gcc make && \
git clone -b 3.1.1 https://github.com/gophernicus/gophernicus.git && \
cd gophernicus && \
sed -i 's/\"\/.\"/\"\/..\"/g' src/gophernicus.c && \
sed -i "s/if (dir\[i\]\.name\[0\] /\/\//g" src/menu.c && \
./configure --listener=xinetd && \
make && \
make install && \
cd / && \
rm -rf /tmp/gophernicus
RUN mkdir -p /var/gopher
COPY ./app /var/gopher
COPY gophernicus /etc/xinetd.d/gophernicus

# LPE Cron Install Cron
RUN apt-get -y install cron
COPY ./crontab /etc/crontab

# Flags
COPY ./flag_user.txt /flag_user.txt
COPY ./flag_root.txt /flag_root.txt
RUN chown -R robert:robert /flag_user.txt && \
chmod 444 /flag_user.txt
RUN chown -R administrator:administrator /flag_root.txt && \
chmod 400 /flag_root.txt

# Start Challenge
RUN echo "[+] Start challenge"
WORKDIR /
COPY entrypoint.sh .
RUN chmod +x entrypoint.sh
EXPOSE 22 70 80
CMD ["/entrypoint.sh"]