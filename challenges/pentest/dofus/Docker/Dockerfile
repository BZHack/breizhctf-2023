FROM debian:stable

ENV TIMEZONE Europe/Paris

RUN apt update -y && apt upgrade -y

# SSH (openssh-server) + Pivot SSH (chall)
RUN echo "[+] Install SSH server (+ config)"
RUN apt install -y openssh-server
RUN useradd chall --no-create-home --shell /bin/false
RUN echo 'chall:chall' | chpasswd

# Apache & PHP 5.6
RUN echo "[+] Install Apache2 & PHP 5.6"
RUN apt install -y apache2 ca-certificates apt-transport-https lsb-release wget gnupg git
RUN wget -q https://packages.sury.org/php/apt.gpg -O- | apt-key add -
RUN echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" | tee /etc/apt/sources.list.d/php.list
RUN apt update
RUN apt install -y php5.6 php5.6-cli php5.6-common php5.6-curl php5.6-mbstring php5.6-mysql php5.6-xml

# MySQL (mariadb-server)
RUN echo "[+] Install MySQL Server (+ config)"
RUN apt install -y mariadb-server mariadb-client
COPY ./sql /sql
RUN service mariadb start && \
mariadb -e "CREATE USER 'user'@'%' IDENTIFIED BY '4L5uMjHvCg07';" && \
mariadb -e "CREATE DATABASE ancestra;" && \
mariadb -e "GRANT ALL ON ancestra.* TO 'user'@'%'; FLUSH PRIVILEGES;" && \
mariadb ancestra < /sql/1.sql && \
mariadb ancestra < /sql/2.sql && \
mariadb ancestra < /sql/3.sql
RUN rm -rf /sql

# Web Challenge installation
RUN echo "[+] Copy web sources (+ config)"
WORKDIR /var/www/html
RUN rm -rf *
COPY app .
RUN git config --global user.email "barbok@dofus.com" && \
git config --global user.name "Barbok" && \
git init && \
git add * && git reset configuration/config.php && \
git commit -m "CrÃ©ation du CMS ðŸŽ®"

# User barbok & Flag
RUN echo "[+] Create user & flag"
RUN useradd -ms /bin/bash barbok
RUN echo 'barbok:r69*H27anxxc' | chpasswd
WORKDIR /home/barbok
COPY flag.txt .

# Start Challenge
RUN echo "[+] Start challenge"
WORKDIR /
COPY entrypoint.sh .
RUN chmod +x entrypoint.sh
EXPOSE 22 80 443 3306
CMD ["/entrypoint.sh"]