<?php

class Configurations
{
    function __construct(
        public string $storagePath
    ) {
    }

    function listConfigurations(): array
    {
        return array_diff(scandir($this->storagePath), ['.', '..']);
    }

    function downloadConfig(string $config)
    {
        $file = join('/', [$this->storagePath, basename($config), 'client.ovpn']);

        if (!file_exists($file)) {
            http_response_code(404);
            die('Configuration not found');
        }

        header('Content-Description: File Transfer');
        header('Content-Type: application/octet-stream');
        header('Content-Disposition: attachment; filename=challenge.ovpn');
        header('Content-Transfer-Encoding: binary');
        header('Expires: 0');
        header('Cache-Control: must-revalidate');
        header('Pragma: public');
        header('Content-Length: ' . filesize($file));

        $ovpn = file_get_contents($file);
        echo str_replace('remote localhost 1194', "remote {$_SERVER['SERVER_NAME']} {$_SERVER['SERVER_PORT']}", $ovpn);

        file_put_contents(__DIR__ . '/downloaded.txt', 'yes');
    }

    function alreadyDownloaded(): bool {
        return file_get_contents(__DIR__ . '/downloaded.txt') === 'yes';
    }
}
