FROM debian:stable

RUN apt-get update && apt-get install -y python3 socat wget git libc6-dev gcc make perl libz-dev
RUN apt remove -y openssl openssh-server

WORKDIR /tmp/

# Weak OpenSSL
RUN cd /tmp/ && \
git clone https://github.com/CVE-2008-0166/key_generator.git && \
cd key_generator/openssl-0.9.8f_with_CVE-2008-0166/ && \
./config no-asm && \
cd crypto/bn && \
perl bn_prime.pl > bn_prime.h && \
cd ../../ && \
ln -s /usr/bin/perl /usr/local/bin/perl && \
make && \
make install_sw && \
export PATH="$PATH:/usr/local/ssl/bin/" && \
cd / && \
rm -rf /tmp/key_generator

# Weak OpenSSH
RUN cd /tmp/ && \
wget https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-4.6p1.tar.gz && \
tar -xvf openssh-4.6p1.tar.gz && \
cd openssh-4.6p1 && \
./configure && \
make && \
make install && \
useradd sshd && \
echo "RSAAuthentication yes" >> /usr/local/etc/sshd_config && \
echo "PubkeyAuthentication yes" >> /usr/local/etc/sshd_config && \
echo "PasswordAuthentication no" >> /usr/local/etc/sshd_config && \
echo "PermitRootLogin no" >> /usr/local/etc/sshd_config && \
cd / && \
rm -rf /tmp/openssh*


# Create User with weak ssh key
# https://github.com/g0tmi1k/debian-ssh/blob/master/common_keys/debian_ssh_rsa_2048_x86.tar.bz2
# ff4602062c7d74bef8830c3e850c5022-10350
RUN useradd -m ${USER:-owen} -s /bin/bash
RUN echo "${USER:-owen}:${PASS:-7uSoO0s22sEkJMPo}" | chpasswd
RUN mkdir /home/${USER:-owen}/.ssh && \
chmod 700 /home/${USER:-owen}/.ssh && \
chown -R ${USER:-owen}:${USER:-owen} /home/${USER:-owen}/.ssh
WORKDIR /home/${USER:-owen}/.ssh
COPY ff4602062c7d74bef8830c3e850c5022-10350 id_dsa
COPY ff4602062c7d74bef8830c3e850c5022-10350.pub authorized_keys
RUN chown -R ${USER:-owen}:${USER:-owen} /home/${USER:-owen}/.ssh/*
RUN chmod 640 authorized_keys
WORKDIR /home/${USER:-owen}
COPY flag_user.txt .
RUN chown -R ${USER:-owen}:${USER:-owen} /home/${USER:-owen}/flag_user.txt

# LPE
RUN echo "root:root" | chpasswd
WORKDIR /root
COPY flag_root.txt .

ENTRYPOINT ["/usr/local/sbin/sshd","-D"]
